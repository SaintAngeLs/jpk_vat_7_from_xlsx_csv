@page "/"
@using Microsoft.AspNetCore.Components.Forms
@inject JpkVat7.LibClient.Web.Wasm.Services.JpkGrpcUploadClient GrpcClient
@inject IJSRuntime JS

<MudPaper Class="pa-4" Elevation="1" Rounded="Rounded.Lg">
    <MudStack Spacing="2">

        <MudText Typo="Typo.h5">Convert file to JPK XML</MudText>

        <MudAlert Severity="Severity.Info" Dense="true">
            Upload one <b>.csv</b> or <b>.xlsx</b>, then click Convert. Conversion is done on the server via gRPC-Web (no browser freeze).
        </MudAlert>

        @if (!string.IsNullOrWhiteSpace(_status))
        {
            <MudAlert Severity="Severity.Info" Dense="true">
                @_status
            </MudAlert>
        }

        <MudStack Direction="Row" Spacing="2" AlignItems="AlignItems.Center">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OpenFilePicker">
                Choose CSV/XLSX
            </MudButton>

            <InputFile id="filePicker"
                       OnChange="OnInputFileChanged"
                       accept=".csv,.xlsx"
                       style="display:none" />
        </MudStack>

        @if (_file is not null)
        {
            <MudText Typo="Typo.body2">
                Selected: <b>@_file.Name</b> (@($"{_file.Size / 1024.0:F1} KB"))
            </MudText>
        }

        <MudStack Direction="Row" Spacing="2" AlignItems="AlignItems.Center">
            <MudButton Disabled="@(_file is null || _busy)"
                       OnClick="ConvertAsync"
                       Variant="Variant.Filled"
                       Color="Color.Secondary">
                @(_busy ? "Converting..." : "Convert to XML")
            </MudButton>

            <MudButton Disabled="@string.IsNullOrWhiteSpace(_xml)"
                       OnClick="DownloadXmlAsync"
                       Variant="Variant.Outlined">
                Download XML
            </MudButton>
        </MudStack>

        @if (!string.IsNullOrWhiteSpace(_error))
        {
            <MudAlert Severity="Severity.Error" Dense="true">
                @_error
            </MudAlert>
        }

        @if (!string.IsNullOrWhiteSpace(_xml))
        {
            <MudDivider Class="my-2" />
            <MudText Typo="Typo.h6">XML Preview</MudText>

            <MudTextField Lines="18"
                          ReadOnly="true"
                          Variant="Variant.Outlined"
                          Value="@_xml"
                          FullWidth="true" />
        }
    </MudStack>
</MudPaper>

@code {
    private IBrowserFile? _file;
    private bool _busy;
    private string _xml = "";
    private string _error = "";
    private string _status = "";

    private async Task SetStatusAsync(string text)
    {
        _status = text;
        await InvokeAsync(StateHasChanged);
        await Task.Yield();
    }

    private async Task ConvertAsync()
    {
        if (_file is null) return;

        _busy = true;
        _error = "";
        _xml = "";

        await SetStatusAsync("Starting...");

        try
        {
            // Longer than 20s because upload + server processing can take time
            using var cts = new CancellationTokenSource(TimeSpan.FromSeconds(120));

            var reply = await GrpcClient.UploadAndConvertAsync(_file, cts.Token, SetStatusAsync);

            if (!reply.Success)
            {
                _error = string.IsNullOrWhiteSpace(reply.ErrorMessage)
                    ? "Conversion failed."
                    : reply.ErrorMessage;

                if (!string.IsNullOrWhiteSpace(reply.ValidationMessage))
                    _error += "\n" + reply.ValidationMessage;

                await SetStatusAsync("Failed.");
                return;
            }

            _xml = reply.Xml ?? "";
            await SetStatusAsync("Done.");
        }
        catch (OperationCanceledException)
        {
            _error = "Timed out / cancelled.";
            await SetStatusAsync("Failed (timeout).");
        }
        catch (Exception ex)
        {
            _error = ex.Message;
            await SetStatusAsync("Failed (exception).");
        }
        finally
        {
            _busy = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task DownloadXmlAsync()
    {
        if (string.IsNullOrWhiteSpace(_xml)) return;

        var baseName = (_file?.Name ?? "jpk")
            .Replace(".xlsx", "", StringComparison.OrdinalIgnoreCase)
            .Replace(".csv", "", StringComparison.OrdinalIgnoreCase);

        await JS.InvokeVoidAsync("downloadTextFile", $"{baseName}.xml", _xml, "application/xml");
    }

    private async Task OpenFilePicker()
        => await JS.InvokeVoidAsync("clickById", "filePicker");

    private void OnInputFileChanged(InputFileChangeEventArgs e)
    {
        _file = e.File;
        _xml = "";
        _error = "";
        _status = "File selected. Ready to convert.";
    }
}
